#include "dsk6713_aic23.h"

Uint32 input_sample();
void output_sample(int out_data);
void comm_intr();

Uint32 fs = DSK6713_AIC23_FREQ_96KHZ;


#define    N     64      // Nombre de coefficients du filtre

#define    Qk     19      // representation en virgule fixe en Qk

// Frequence d'echantillonnage Fs = 96000

short h[64]= {21,50,97,169,271,411,597,839,1144,1520,1975,2516,3146,3868,4684,5589,
6580,7647,8779,9962,11178,12408,13630,14821,15957,17014,17971,18804,19496,20030,20393,20577,
20577,20393,20030,19496,18804,17971,17014,15957,14821,13630,12408,11178,9962,8779,7647,6580,
5589,4684,3868,3146,2516,1975,1520,1144,839,597,411,271,169,97,50,21 };

short Xn;
short XnBuf[N+1],YnBuf[N];

int Yn;

short i = 0 , j = 0;

Uint16 n = 0, m =0;

short TabModulation[192] =
 {32767,32749,32697,32609,32487,32329,32137,31911,31650,31356,31028,30667,30273,29846,29388,28898,
28377,27826,27245,26635,25996,25329,24636,23915,23170,22399,21605,20787,19947,19086,18204,17303,
16384,15446,14492,13523,12539,11542,10533,9512,8481,7441,6393,5338,4277,3212,2143,1072,
0,-1072,-2143,-3212,-4277,-5338,-6393,-7441,-8481,-9512,-10533,-11542,-12539,-13523,-14492,-15446,
-16384,-17303,-18204,-19086,-19947,-20787,-21605,-22399,-23170,-23915,-24636,-25329,-25996,-26635,-27245,-27826,
-28377,-28898,-29388,-29846,-30273,-30667,-31028,-31356,-31650,-31911,-32137,-32329,-32487,-32609,-32697,-32749,
-32767,-32749,-32697,-32609,-32487,-32329,-32137,-31911,-31650,-31356,-31028,-30667,-30273,-29846,-29388,-28898,
-28377,-27826,-27245,-26635,-25996,-25329,-24636,-23915,-23170,-22399,-21605,-20787,-19947,-19086,-18204,-17303,
-16384,-15446,-14492,-13523,-12539,-11542,-10533,-9512,-8481,-7441,-6393,-5338,-4277,-3212,-2143,-1072,
0,1072,2143,3212,4277,5338,6393,7441,8481,9512,10533,11542,12539,13523,14492,15446,
16384,17303,18204,19086,19947,20787,21605,22399,23170,23915,24636,25329,25996,26635,27245,27826,
28377,28898,29388,29846,30273,30667,31028,31356,31650,31911,32137,32329,32487,32609,32697,32749};




short SignalPorteuse[192], SignalModulation [192], Signaldemodulation[192];
Uint16 PAS=37;
int  SM = 0, D = 1, k = 8;


interrupt void c_int11()
{


	m = ( PAS * n ) % 192;
	Xn = TabModulation[m];
	SignalPorteuse [n] = Xn;

	//output_sample(SignalPorteuse [n]);

	Xn = input_sample();

	SM = (int) ( SignalPorteuse [n] * Xn );
	SM = (int)  ( SM / D );
	SM = (int) ( SM >> k );
	SM = SM + (int) ( SignalPorteuse [n] );

	SignalModulation[n] = (short) (SM >> 1);

	//output_sample(SignaldModulation [n]);



	Signaldemodulation [n] = (short) ((SignalModulation[n] * SignalPorteuse [n]) >> 15);

	//output_sample(Signaldemodulation [n]);




	Xn = Signaldemodulation [n];
	XnBuf[0] = Xn;
	Yn = 0;

	for (i=N-1;i>=0;i--){

		Yn = Yn + (int ) ((h[i]*XnBuf[i]) >> 18) ;

		XnBuf[i+1]=XnBuf[i];

	}

	YnBuf[j]= (short) Yn;
	output_sample(YnBuf[j]);
	j = (j + 1) % N;





	n = (n + 1) % 192;
	return;
}

main()
{
	PAS = 37;
	D=3;
	k=13;
	comm_intr();
	for (n=0;n<192;n++){
		SignalPorteuse [n] = 0;
	}
	while(1);
}
